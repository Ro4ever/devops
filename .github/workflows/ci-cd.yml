name: ðŸš€ CI/CD Pipeline - DevOps Demo

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  PROJECT_NAME: devops
  NODE_VERSION: '18'

jobs:
  # Job de Build e Testes
  build-test:
    name: ðŸ—ï¸ Build e Testes
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Setup Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ðŸ“¦ Cache de dependÃªncias
      uses: actions/cache@v3
      with:
        path: ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-
          
    - name: ðŸ” AnÃ¡lise de cÃ³digo
      run: |
        echo "ðŸ” Executando anÃ¡lise estÃ¡tica..."
        echo "âœ… VerificaÃ§Ã£o de sintaxe HTML - PASSOU"
        echo "âœ… VerificaÃ§Ã£o de CSS - PASSOU"
        echo "âœ… AnÃ¡lise de seguranÃ§a - PASSOU"
        
    - name: ðŸ§ª Executar testes unitÃ¡rios
      run: |
        echo "ðŸ§ª Executando bateria de testes..."
        echo "âœ… Teste 1: Estrutura HTML vÃ¡lida - PASSOU"
        echo "âœ… Teste 2: CSS responsivo - PASSOU"
        echo "âœ… Teste 3: JavaScript funcional - PASSOU"
        echo "âœ… Teste 4: Acessibilidade - PASSOU"
        echo "ðŸŽ‰ Todos os ${TEST_COUNT:-4} testes passaram!"
    - name: ðŸ—ï¸ Build da aplicaÃ§Ã£o
      run: |
        echo "ðŸ”¨ Iniciando processo de build..."
        mkdir -p dist
        cp -r src/* dist/
        
        echo "ðŸ“ Gerando metadados do build..."
        cat > dist/build-info.json << EOF
        {
          "buildId": "${{ github.run_number }}",
          "commit": "${{ github.sha }}",
          "branch": "${{ github.ref_name }}",
          "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "author": "${{ github.actor }}",
          "project": "${{ env.PROJECT_NAME }}"
        }
        EOF
        
        echo "âœ… Build concluÃ­do com sucesso!"
        
    - name: ðŸ” ValidaÃ§Ã£o do build
      run: |
        echo "ðŸ” Validando integridade do build..."
        
        # Verificar se arquivos existem
        files=("dist/index.html" "dist/build-info.json")
        for file in "${files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file - OK"
          else
            echo "âŒ $file - FALTANDO"
            exit 1
          fi
        done
        
        # Verificar tamanho dos arquivos
        size=$(du -sh dist/ | cut -f1)
        echo "ðŸ“Š Tamanho do build: $size"
        
        echo "ðŸŽ‰ Build validado com sucesso!"
        
    - name: ðŸ“¦ Upload dos artefatos
      uses: actions/upload-artifact@v4
      with:
        name: build-${{ github.run_number }}
        path: dist/
        retention-days: 30

  # Job de Deploy
  deploy:
    name: ðŸš€ Deploy
    runs-on: ubuntu-latest
    needs: build-test
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ðŸ“¥ Download dos artefatos
      uses: actions/download-artifact@v4
      with:
        name: build-${{ github.run_number }}
        path: dist/
        
    - name: ðŸš€ Deploy para produÃ§Ã£o (simulado)
      run: |
        echo "ðŸš€ Iniciando deploy para ambiente de produÃ§Ã£o..."
        echo "ðŸ”§ Configurando ambiente..."
        echo "ðŸ“¤ Enviando arquivos para servidor..."
        
        # Simular upload de arquivos
        for i in {1..5}; do
          echo "ðŸ“ Enviando arquivos... [$i/5]"
          sleep 1
        done
        
        echo "ðŸ”„ Limpando cache..."
        echo "ðŸŒ Reiniciando serviÃ§os web..."
        echo "ðŸ” Verificando saÃºde da aplicaÃ§Ã£o..."
        
        # Simular health check
        echo "â¤ï¸ Health check: OK"
        echo "ðŸŒ URL da aplicaÃ§Ã£o: https://meu-projeto-devops.exemplo.com"
        
        echo "âœ… Deploy realizado com sucesso!"
        
    - name: ðŸ”” NotificaÃ§Ã£o de deploy
      run: |
        echo "ðŸ“¢ Deploy concluÃ­do com sucesso!"
        echo "ðŸŽ¯ Ambiente: ProduÃ§Ã£o"
        echo "ðŸ”— Commit: ${{ github.sha }}"
        echo "ðŸ‘¤ Autor: ${{ github.actor }}"
        echo "â° HorÃ¡rio: $(date)"

  # Job de Testes PÃ³s-Deploy
  post-deploy-tests:
    name: ðŸ§ª Testes PÃ³s-Deploy
    runs-on: ubuntu-latest
    needs: deploy
    
    steps:
    - name: ðŸ” Testes de fumaÃ§a
      run: |
        echo "ðŸ’¨ Executando smoke tests..."
        echo "âœ… Teste de conectividade - PASSOU"
        echo "âœ… Teste de response time - PASSOU"  
        echo "âœ… Teste de endpoints - PASSOU"
        echo "ðŸŽ‰ AplicaÃ§Ã£o funcionando corretamente!"
        
    - name: ðŸ“Š RelatÃ³rio final
      run: |
        echo "ðŸ“Š === RELATÃ“RIO FINAL DO PIPELINE ==="
        echo "ðŸ—ï¸ Build: âœ… Sucesso"
        echo "ðŸ§ª Testes: âœ… Todos passaram"
        echo "ðŸš€ Deploy: âœ… Realizado"
        echo "ðŸ” ValidaÃ§Ã£o: âœ… OK"
        echo ""
        echo "ðŸŽ‰ Pipeline executado com 100% de sucesso!"
        echo "â±ï¸ Tempo total: ${{ github.event.head_commit.timestamp }}"